<html>
  <body>
    <script type="module">
      import {
        expect,
        fixture,
        fixtureCleanup,
        elementUpdated,
      } from "@open-wc/testing";
      import { setViewport } from "@web/test-runner-commands";
      import { runTests } from "@web/test-runner-mocha";
      import * as ethicalads from "../src/ethicalads.js";

      // Define the config globally to be able to override on ``beforeEach`` and inside each test
      let config;

      runTests(async () => {
        beforeEach(() => {
          config = {
            addons: {
              ethicalads: {
                enabled: true,
                ad_free: false,
                campaign_types: ["community", "paid"],
                keywords: ["docs", "data-science"],
                publisher: "readthedocs",
              },
            },
          };
        });

        afterEach(() => {
          // Remove all the fixtures added
          fixtureCleanup();

          // Remove the script added

          document.querySelector("#ethicaladsjs")?.remove();
          // Remove the ad added
          document.querySelector("#readthedocs-ea")?.remove();
        });

        describe("EthicalAd addon", () => {
          it("ad placement defined by the user", async () => {
            await fixture(
              '<div id="ethical-ad-placement" class="ad-flat"></div>',
            );
            const addon = new ethicalads.EthicalAdsAddon(config);

            const element = document.querySelector("#ethical-ad-placement");

            expect(element).to.have.attribute(
              "data-ea-publisher",
              "readthedocs",
            );
            expect(element).to.have.attribute(
              "data-ea-type",
              "readthedocs-sidebar",
            );

            // Keep the CSS classes added manually by the user
            expect(element).to.have.class("ad-flat");

            // Required `await` on this to generate the snapshot file
            await expect(element).dom.to.equalSnapshot();
          });

          it("ad placement injected", async () => {
            // We need the width to be bigger than 1300px for the ad to be injected
            await setViewport({ width: 1600, height: 640 });

            const addon = new ethicalads.EthicalAdsAddon(config);
            const element = document.querySelector("#readthedocs-ea");
            await expect(element).dom.to.equalSnapshot();
          });

          it("inject ethicalads.min.js", async () => {
            const addon = new ethicalads.EthicalAdsAddon(config);

            const element = document.querySelector("#ethicaladsjs");
            expect(element).to.exist;
            expect(element).to.have.attribute(
              "src",
              "https://media.ethicalads.io/media/client/ethicalads.min.js",
            );
            expect(element).to.have.attribute("type", "text/javascript");
            expect(element).to.have.attribute("async", "true");
          });
        });
      });
    </script>
  </body>
</html>
